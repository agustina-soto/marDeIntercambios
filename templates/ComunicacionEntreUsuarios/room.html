{% extends "base.html" %}
{% block title %}{{ room.name }} | {% endblock %}
{% block messages %}
    <!-- No hacer nada en esta plantilla para anular el bloque de mensajes -->
{% endblock %}
{% block content %}

<div class="container mt-5 d-flex justify-content-center">
    <div style="width: 80%;">
        <div class="room-title text-center mb-4">
            <h1 class="display-4">{{ room.name }}</h1>
        </div>

        <div class="chat-container card" style="max-width: 100%;"> 
            <div class="card-body">
                <div class="chat-messages mb-3" id="chat-messages" style="height: 400px; overflow-y: auto;">
                    {% for message in messages %}
                        <div class="message">
                            <p class="message-user font-weight-bold"> <b>{{ message.user.username }}:</b> </p>
                            <p class="message-body">{{ message.content }}</p>
                            {% if message.foto %}
                                <img src="{{ message.foto.url }}" alt="Foto adjunta" width="40%" height="40%">
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="send-container">
                    <form action="." method="post" enctype="multipart/form-data" class="justify-content-start"> <!-- Agregando enctype="multipart/form-data" para admitir la carga de archivos -->
                        {% csrf_token %}
                        <input type="text" name="content" class="form-control mr-2 p-2"  placeholder="Your message..." id="chat-message-input">
                        <input type="file" name="foto" class="mr-2"> <!-- Campo de entrada de archivos -->
                        <button class="btn btn-success p-2" id="chat-message-submit">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
    {{ room.slug|json_script:"json-roomname" }}
    {{ request.user.username|json_script:"json-username" }}
    <script>
        scrollToBottom();
        const roomName = JSON.parse(document.getElementById("json-roomname").textContent);
        const userName = JSON.parse(document.getElementById("json-username").textContent);
        const chatSocket = new WebSocket(`ws://${window.location.host}/ws/${roomName}/`);
    
        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
    
            if (data.message) {
                const html = `<div class="message">
                                <p class="message-user">${data.username}: </p>
                                <p class="message-body">${data.message}</p>
                              </div>`;
                document.querySelector("#chat-messages").innerHTML += html;
                scrollToBottom();
            }
        };
    
        chatSocket.onclose = function (e) {
            console.log("Chat socket closed unexpectedly");
        };
    
        const messageInputDom = document.querySelector("#chat-message-input");
        const messageSubmitButton = document.querySelector("#chat-message-submit");
    
        function toggleSubmitButton() {
            if (messageInputDom.value.trim() === "") {
                messageSubmitButton.disabled = true;
            } else {
                messageSubmitButton.disabled = false;
            }
        }
    
        toggleSubmitButton();
    
        messageInputDom.addEventListener("input", toggleSubmitButton);
    
        messageSubmitButton.onclick = function (e) {
            e.preventDefault();
    
            const message = messageInputDom.value;
    
            chatSocket.send(JSON.stringify({
                "message": message,
                "username": userName,
                "room": roomName
            }));
    
            messageInputDom.value = "";
            toggleSubmitButton();
            return false;
        };
    
        function scrollToBottom() {
            const objDiv = document.querySelector("#chat-messages");
            objDiv.scrollTop = objDiv.scrollHeight;
        }
    </script>
{% endblock %}
